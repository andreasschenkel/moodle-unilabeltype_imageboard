{"version":3,"file":"imageboardpreviewrenderer.min.js","sources":["../src/imageboardpreviewrenderer.js"],"sourcesContent":["/**\n * Unilabel type imageboard\n *\n * @author      Andreas Schenkel\n * @copyright   Andreas Schenkel {@link https://github.com/andreasschenkel}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nexport const init = () => {\n    // Timeout notwendig, damit das Bild in der Draftarea \"vorhanden\" ist.\n    // document.querySelector('#id_unilabeltype_imageboard_backgroundimage_fieldset .filemanager-container .realpreview');\n    setTimeout(refreshBackgroundImage, 3000);\n    setTimeout(registerAllEventlistener, 4000);\n    // To show all images on pageload.\n    setTimeout(refreshAllImages, 5000);\n\n    /**\n     * Register eventlistener to the all input fields of the form to register\n     * focus-out events from input fields in order to trigger a fresh of the preview.\n     */\n    function registerAllEventlistener() {\n        // First: When uploading a backgroundimage the backgroundimage of the backgroundimagediv must be updated.\n        let backgroundfileNode = document.getElementById('id_unilabeltype_imageboard_backgroundimage_fieldset');\n        if (backgroundfileNode) {\n            let observer = new MutationObserver(refreshBackgroundImage);\n            observer.observe(backgroundfileNode, {attributes: true, childList: true, subtree: true});\n        }\n        // Also add listener for canvas size\n        let canvasx = document.getElementById('id_unilabeltype_imageboard_canvaswidth');\n        if (canvasx) {\n            let observer = new MutationObserver(refreshBackgroundImage);\n            observer.observe(canvasx, {attributes: true, childList: true, subtree: true});\n        }\n        let canvasy = document.getElementById('id_unilabeltype_imageboard_canvasheight');\n        if (canvasy) {\n            let observer = new MutationObserver(refreshBackgroundImage);\n            observer.observe(canvasy, {attributes: true, childList: true, subtree: true});\n        }\n\n        // Second add listener to the add image button for new added images.\n        let add_element_button = document.querySelectorAll('[id^=\"button-mform1\"]')[0];\n        add_element_button.addEventListener(\"click\", function() {\n            // No we can get the new form input fields and register a focusout listener\n            // and in case of focus out we update the rendered image.\n            // Thus we have to add a new div without any content and whenever there is a focusout event we will update this.\n            // Then register listener for all images already exists\n            setTimeout(function() {\n                // An element was added so we have to add a div for the image\n                // to the dom and wie need to register listener to the ne inputfieds of the element\n                const singleElements = document.querySelectorAll('[id^=\"fitem_id_unilabeltype_imageboard_title_\"]');\n                let number = singleElements.length;\n                addImageToDom(number - 1);\n                setTimeout(function() {\n                    registerAllListenersForAllElements();\n                }, 1000);\n            }, 1000);\n        });\n\n        // Third register listener for all images already exists\n        setTimeout(function() {\n            registerAllListenersForAllElements();\n        }, 1000);\n    }\n\n    /**\n     *\n     */\n    function registerAllListenersForAllElements() {\n        // Third register listener for all images already exists\n        const singleElements = document.querySelectorAll('[id^=\"fitem_id_unilabeltype_imageboard_title_\"]');\n        for (let i = 0; i < singleElements.length; i++) {\n            let number = singleElements[i].getAttribute('id').split('fitem_id_unilabeltype_imageboard_title_')[1];\n            registerAllListenersForSingleElement(number);\n        }\n    }\n\n    /**\n     * Registers to every input field a listener do find focusout events andthen call refreshimage().\n     * @param {int} number\n     */\n    function registerAllListenersForSingleElement(number) {\n        const input_title = document.getElementById('id_unilabeltype_imageboard_title_' + (number));\n        input_title.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n\n        // Eventlistener an das Inputfeld für die x-Koordinate anhängen\n        // Here the position of imagediv is set, not the position of the image itself, but the image is in the div.\n        const input_xposition = document.getElementById('id_unilabeltype_imageboard_xposition_' + (number));\n        input_xposition.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n        const input_yposition = document.getElementById('id_unilabeltype_imageboard_yposition_' + (number));\n        input_yposition.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n\n        // Eventlistener an das Inputfeld für die width anhängen\n        const input_targetwidth = document.getElementById('id_unilabeltype_imageboard_targetwidth_' + (number));\n        input_targetwidth.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n\n        const input_targetheight = document.getElementById('id_unilabeltype_imageboard_targetheight_' + (number));\n        input_targetheight.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n\n        const input_border = document.getElementById('id_unilabeltype_imageboard_border_' + (number));\n        input_border.addEventListener(\"focusout\", function() {\n            refreshImage(number);\n        });\n\n        let imagefileNode = document.getElementById('fitem_id_unilabeltype_imageboard_image_' + (number));\n        if (imagefileNode) {\n            let observer = new MutationObserver(refreshImage);\n            observer.observe(imagefileNode, {attributes: true, childList: true, subtree: true});\n        }\n    }\n\n    /**\n     * Sets the background image of the SVG to the current image in filemanager.\n     */\n    function refreshBackgroundImage() {\n        // previewimage vom filemanager id_unilabeltype_imageboard_backgroundimage_fieldset erhalten\n        let filemanagerbackgroundimagefieldset = document.getElementById('id_unilabeltype_imageboard_backgroundimage_fieldset');\n        let previewimage = filemanagerbackgroundimagefieldset.getElementsByClassName('realpreview');\n        let backgrounddiv = document.getElementById('unilabel-imageboard-background-area');\n        if (previewimage.length > 0) {\n            let backgroundurl = previewimage[0].getAttribute('src').split('?')[0];\n            // If the uploaded file reuses the filename of a previously uploaded image, they differ\n            // only in the oid. So one has to append the oid to the url.\n            if (previewimage[0].getAttribute('src').split('?')[1].includes('&oid=')) {\n                backgroundurl += '?oid=' + previewimage[0].getAttribute('src').split('&oid=')[1];\n            }\n            backgrounddiv.style.background = 'red'; // just to indicate changes during development.\n            backgrounddiv.style.backgroundSize = 'cover';\n            backgrounddiv.style.backgroundImage = \"url('\" + backgroundurl + \"')\";\n\n            const canvaswidthinput = document.getElementById('id_unilabeltype_imageboard_canvaswidth');\n            let canvaswidthselected = canvaswidthinput.selectedOptions;\n            let canvaswidth = canvaswidthselected[0].value;\n            backgrounddiv.style.width = canvaswidth + \"px\";\n\n            const canvasheightinput = document.getElementById('id_unilabeltype_imageboard_canvasheight');\n            let canvasheightselected = canvasheightinput.selectedOptions;\n            let canvasheight = canvasheightselected[0].value;\n            backgrounddiv.style.height = canvasheight + \"px\";\n        } else {\n            // Image might be deleted so update the backroundidv and remove backgroundimage in preview;\n            // ToDo    if (previewimage.length > 0) does not recognize when an image is deleted so we need a different condition!\n            backgrounddiv.style.background = 'green'; // just to indicate changes during development.\n            backgrounddiv.style.backgroundImage = \"url('')\";\n            const canvaswidthinput = document.getElementById('id_unilabeltype_imageboard_canvaswidth');\n            let canvaswidthselected = canvaswidthinput.selectedOptions;\n            let canvaswidth = canvaswidthselected[0].value;\n            backgrounddiv.style.width = canvaswidth + \"px\";\n\n            const canvasheightinput = document.getElementById('id_unilabeltype_imageboard_canvasheight');\n            let canvasheightselected = canvasheightinput.selectedOptions;\n            let canvasheight = canvasheightselected[0].value;\n            backgrounddiv.style.height = canvasheight + \"px\";\n        }\n    }\n\n    /**\n     * Gets the number of ALL elements in the form and then adds a div for each element to the dom if not already exists.\n     * We need a timeout\n     */\n    function refreshAllImages() {\n        const singleElements = document.querySelectorAll('[id^=\"fitem_id_unilabeltype_imageboard_image_\"]');\n        for (let i = 0; i < singleElements.length; i++) {\n            // Todo: Skip removed elements that are still in the dom but hidden.\n            let singleElement = singleElements[i].getAttribute('id');\n            let number = singleElement.split('fitem_id_unilabeltype_imageboard_image_')[1];\n            // Check if there exists already a div for this image.\n            const imageid = document.getElementById('unilabel-imageboard-imageid_' + number);\n            if (imageid === null) {\n                // Div does not exist so we need do add it do dom.\n                addImageToDom(number);\n                // ToDo: Do we need a timeout to wait until the dic was added so that refresh can work correctly?\n                // see also refreshImage ... there is already a timeout\n                refreshImage(number);\n            } else {\n                refreshImage(number);\n            }\n        }\n    }\n\n    /**\n     *\n     * @param {int} number\n     */\n    function addImageToDom(number) {\n        let backgroundArea = document.getElementById('unilabel-imageboard-background-area');\n        const imageid = document.getElementById('unilabel-imageboard-imageid_' + number);\n        if (imageid === null) {\n            // This div does not exist so we need do add it do dom.\n            backgroundArea.innerHTML = backgroundArea.innerHTML + renderFromTemplate(number);\n            refreshImage(number);\n        } else {\n            // Div already exists so we need only to refresh the image.\n            refreshImage(number);\n        }\n    }\n\n    /**\n     * Renders the div for the image in preview.\n     *\n     * @param {int} number\n     * @returns {string}\n     */\n    function renderFromTemplate(number) {\n        const imagedivashtml =\n            \"<div id='unilabel_imageboard_imagediv_\" + number + \"' style='z-index: 5; position: absolute;'>\" +\n            \"<div id='imageidtitle_\" + number + \"' class='unilabel-imageboard-title rounded' \" +\n            \" style='position: relative;'>Überschrift\" +\n            \"</div>\" +\n            \"<div id='imageidimage_\" + number + \"'>\" +\n            \"<img class='image' src='' id='unilabel-imageboard-imageid_\" + number + \"' style='position: relative;'>\" +\n            \"</div>\" +\n            \"</div>\";\n        return imagedivashtml;\n    }\n\n    /**\n     * If an image was uploaded or inputfields in the form changed then we need to refrech\n     * this image.\n     * @param {int} number\n     */\n    function refreshImage(number) {\n        // When there was an upload, then the number is NOT a number.\n        // ToDo: Do not yet know the best way how I will get the number in his case.\n        // For now if it is a number the normal refresh can be used and only ONE image will be refreshed.\n        // In the else code ther will be a refresh of ALL images until I can refactor this.\n        if (!Array.isArray(number)) {\n            let imageid = document.getElementById('unilabel-imageboard-imageid_' + number);\n            // Werte für das image setzen\n            let imagedata = getAllImagedataFromForm(number);\n            imageid.style.background = 'blue';\n            imageid.src = imagedata['src'];\n            const imagediv = document.getElementById('unilabel_imageboard_imagediv_' + number);\n            imagediv.style.left = parseInt(imagedata['xposition']) + \"px\";\n            imagediv.style.top = parseInt(imagedata['yposition']) + \"px\";\n\n            // Breite und Höhe\n            if (imagedata['targetwidth'] != 0) {\n                imageid.style.width = imagedata['targetwidth'] + \"px\";\n            } else {\n                imageid.style.width = \"auto\";\n            }\n            if (imagedata['targetheight'] != 0) {\n                imageid.style.height = imagedata['targetheight'] + \"px\";\n            } else {\n                imageid.style.height = \"auto\";\n            }\n            if (imagedata['title'] != \"\") {\n                imageid.title = imagedata['title'];\n            } else {\n                imageid.title = '';\n            }\n            let colourpicker = document.getElementById('id_unilabeltype_imageboard_titlebackgroundcolor_colourpicker');\n            let color = '';\n            if (colourpicker.value == '') {\n                color = '#000000';\n            } else {\n                color = colourpicker.value;\n            }\n            if (imagedata['border'] != 0) {\n                imageid.style.border = imagedata['border'] + \"px solid\";\n                imageid.style.borderColor = color;\n            } else {\n                imageid.style.border = \"0\";\n            }\n\n            // ToDo: add title if not empty\n            let title = imagedata['title'];\n            const imageidtitle = document.getElementById('imageidtitle_' + number);\n            imageidtitle.innerHTML = title;\n        } else {\n            //console.log(\"number ist ein array\" , number);\n            //console.log(\"number[0] ist ein array\" , number[0]);\n            //console.log(\"number[0].attributeName ist ein array\" , number[0].attributeName);\n            //////console.log(\"number[0].target ist ein array\", number[0].target);\n            // ToDo: nur genau den einen enuen listener hinzufügen ...\n            // hier schonaml ALLE\n            setTimeout(function() {\n                registerAllListenersForAllElements();\n            }, 300);\n            setTimeout(function() {\n                refreshAllImages();\n            }, 600);\n        }\n    }\n\n\n    /**\n     * The form has inputfields with date. This function gets the value from the inputfield with the given idselector\n     *\n     * @param {string} idselector 'id_unilabeltype_imageboard_yposition_' + number\n     * @returns {string}\n     */\n   /// function getValueFromForm(idselector) {\n   ///     return document.getElementById(idselector).getAttribute('value');\n   /// }\n\n\n    /**\n     * Get all data from image that is stored in the form and collects them in one array.\n     *\n     * @param {int} number of the image\n     * @returns {*[]} Array with the collected information that are set in the form for the image.\n     */\n    function getAllImagedataFromForm(number) {\n        let imageids = {\n            title: 'id_unilabeltype_imageboard_title_' + number,\n            xposition: 'id_unilabeltype_imageboard_xposition_' + number,\n            yposition: 'id_unilabeltype_imageboard_yposition_' + number,\n            targetwidth: 'id_unilabeltype_imageboard_targetwidth_' + number,\n            targetheight: 'id_unilabeltype_imageboard_targetheight_' + number,\n            src: '',\n            border: 'id_unilabeltype_imageboard_border_' + number,\n        };\n\n        let imagedata = [];\n        imagedata['title'] = document.getElementById(imageids.title).value;\n        imagedata['xposition'] = document.getElementById(imageids.xposition).value;\n        imagedata['yposition'] = document.getElementById(imageids.yposition).value;\n        imagedata['targetwidth'] = document.getElementById(imageids.targetwidth).value;\n        imagedata['targetheight'] = document.getElementById(imageids.targetheight).value;\n\n        // Src der Draftfile ermitteln\n        const element = document.getElementById('id_unilabeltype_imageboard_image_' + number + '_fieldset');\n        const imagetag = element.getElementsByTagName('img');\n        let src = '';\n        if (imagetag.length && imagetag.length != 0) {\n            src = imagetag[0].src;\n            src = src.split('?')[0];\n        }\n        imagedata['src'] = src;\n        imagedata['border'] = document.getElementById(imageids.border).value;\n\n        return imagedata;\n    }\n};\n\n"],"names":["registerAllListenersForAllElements","singleElements","document","querySelectorAll","i","length","registerAllListenersForSingleElement","getAttribute","split","number","getElementById","addEventListener","refreshImage","imagefileNode","MutationObserver","observe","attributes","childList","subtree","refreshBackgroundImage","previewimage","getElementsByClassName","backgrounddiv","backgroundurl","includes","style","background","backgroundSize","backgroundImage","canvaswidth","selectedOptions","value","width","canvasheight","height","refreshAllImages","addImageToDom","backgroundArea","innerHTML","renderFromTemplate","Array","isArray","setTimeout","imageid","imagedata","imageids","title","xposition","yposition","targetwidth","targetheight","src","border","imagetag","getElementsByTagName","getAllImagedataFromForm","imagediv","left","parseInt","top","colourpicker","color","borderColor","backgroundfileNode","canvasx","canvasy"],"mappings":"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"}